name: Build and Deploy Frontend (Production Only)

on:
  push:
    tags: ["v[0-9]+.[0-9]+.[0-9]+"] # ä¸¥æ ¼åŒ¹é…ç‰ˆæœ¬å·æ ‡ç­¾è§¦å‘

env:
  APP_NAME: personal-blog
  PRD_DIR: /www/wwwroot/personal-blog
  KEEP_RELEASES: 5
  NODE_VERSION: 23

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      # --- 1. ç”Ÿæˆ .env æ–‡ä»¶ (å¿…é¡»åœ¨ Build ä¹‹å‰) ---
      # è¿™æ · Next.js æ„å»ºæ—¶èƒ½æ‹¿åˆ°ç¯å¢ƒå˜é‡
      - name: Create .env file
        run: |
          echo "NEXT_PUBLIC_API_BASE_URL=${{ secrets.NEXT_PUBLIC_API_BASE_URL }}" >> .env
          echo "BLOG_BACKEND_URL=${{ secrets.BLOG_BACKEND_URL }}" >> .env
          echo "âœ… .env file created"

      - name: Install & Build
        run: |
          npm ci
          npm run build

      - name: Generate Vars
        id: vars
        run: |
          echo "TS=$(date +%Y%m%d%H%M%S)" >> $GITHUB_OUTPUT
          echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Package Artifacts
        run: |
          # åŒ…å« .env ä¸€èµ·æ‰“åŒ…ï¼Œç¡®ä¿è¿è¡Œæ—¶ PM2 ä¹Ÿèƒ½è¯»å–
          tar -czf release.tar.gz .next public package.json package-lock.json next.config.ts .env

      - name: Upload to Server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          source: "release.tar.gz"
          target: "${{ env.PRD_DIR }}/releases/${{ steps.vars.outputs.TS }}"

      - name: Remote Deploy
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          envs: APP_NAME,KEEP_RELEASES,PRD_DIR
          script: |
            set -euo pipefail
            
            RELEASE_TS="${{ steps.vars.outputs.TS }}"
            RELEASE_PATH="$PRD_DIR/releases/$RELEASE_TS"
            FINAL_APP_NAME="$APP_NAME-prd"

            # 1. è§£å‹å¹¶å®‰è£…ç”Ÿäº§ä¾èµ–
            cd "$RELEASE_PATH"
            tar -xzf release.tar.gz && rm release.tar.gz
            
            echo "ğŸ“¦ Installing production dependencies..."
            npm ci --only=production

            # 2. åŸå­åˆ‡æ¢è½¯é“¾æ¥
            ln -sfn "$RELEASE_PATH" "$PRD_DIR/current"

            # 3. PM2 éƒ¨ç½²é€»è¾‘
            cd "$PRD_DIR/current"
            
            # åœæ­¢å¹¶åˆ é™¤æ—§è¿›ç¨‹ (ç¡®ä¿å®Œå…¨é‡è½½é…ç½®)
            pm2 delete "$FINAL_APP_NAME" || true
            
            echo "ğŸš€ Starting frontend with PM2..."
            # ä½¿ç”¨ç¯å¢ƒå˜é‡æŒ‡å®šç«¯å£å’Œç”Ÿäº§æ¨¡å¼
            NODE_ENV=production PORT=3000 pm2 start npm --name "$FINAL_APP_NAME" -- start
            
            pm2 save

            # 4. æ¸…ç†æ—§ç‰ˆæœ¬
            cd "$PRD_DIR/releases"
            # ä¿®è¡¥äº†ä¹‹å‰çš„ ls å‘½ä»¤ï¼Œç¡®ä¿åªå¤„ç†ç›®å½•ä¸”ä¸æŠ¥é”™
            ls -1dt */ | tail -n +$(($KEEP_RELEASES + 1)) | xargs -I {} rm -rf "{}"
            
            echo "ğŸ‰ Frontend Deployment Finished. Version: ${{ steps.vars.outputs.VERSION }}"